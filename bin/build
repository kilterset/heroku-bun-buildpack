#!/usr/bin/env bash

set -eo pipefail

layers_dir="$1"
env_dir="$2/env"
plan_path="$3"
build_dir="${layers_dir}/bun"
bun_bin="${build_dir}/bin/bun"

function run() {
  echo
  echo "Kilterset/Bun Buildpack"
  echo

  echo  "---> Installing Bun"
  install_bun

  echo "---> Installing dependencies"
  install_dependencies

  echo "---> Writing metadata"
  write_metadata

  exit 0
}

function install_bun() {
  if [ -f "${build_dir}/bin/bun" ]; then
    echo "Using cached Bun install"
  else
    export BUN_INSTALL="${build_dir}"
    curl -fsSL https://bun.sh/install | bash
  fi

  echo "Installed Bun v$($bun_bin --version)"
}

function install_dependencies() {
  mkdir -p "${build_dir}/cache"
  $bun_bin install --production --frozen-lockfile --cache-dir="${build_dir}/cache"
}

function write_metadata() {
  cat <<TOML >"${layers_dir}/store.toml"
[metadata]
last_stack = "${CNB_STACK_ID}"
TOML

  cat << TOML > "${build_dir}.toml"
[types]
build = true
cache = true
launch = true
TOML

  echo "Done."
}

run
