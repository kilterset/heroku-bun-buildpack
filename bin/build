#!/usr/bin/env bash

set -eo pipefail

layers_dir="$1"
env_dir="$2/env"
plan_path="$3"
build_dir="${layers_dir}/bun"

echo
echo "Kilterset/Bun Buildpack"
echo

echo  "---> Installing Bun"

if [ -f "${build_dir}/bin/bun" ]; then
  echo "Using cached Bun install"
else
  export BUN_INSTALL="${build_dir}"
  curl -fsSL https://bun.sh/install | bash
fi

bun_bin="${build_dir}/bin/bun"

echo "Installed Bun v$($bun_bin --version)"

echo "---> Installing dependencies"

mkdir -p "${build_dir}/cache"
$bun_bin install --production --frozen-lockfile --cache-dir="${build_dir}/cache"

cat <<TOML >"${layers_dir}/store.toml"
[metadata]
last_stack = "${CNB_STACK_ID}"
TOML

cat << TOML > "${build_dir}.toml"
[types]
build = true
cache = true
launch = true
TOML

exit 0
